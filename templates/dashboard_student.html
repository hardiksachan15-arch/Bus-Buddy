{% extends "base.html" %}

{% block title %}Student Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="grid">
    <div class="card col-span-2">
        <div class="flex justify-between items-center mb-2">
            <h3 class="flex items-center gap-2">
                <i data-lucide="map" class="text-primary"></i> Live Fleet Map
            </h3>
            <button class="btn btn-sm btn-ghost" onclick="map.invalidateSize(); alert('Map Refreshed')">
                <i data-lucide="refresh-cw" width="14"></i> Refresh
            </button>
        </div>
        <div id="map" style="height: 500px; width: 100%; border-radius: var(--radius-sm);"></div>
    </div>

    <div class="card">
        <h3><i data-lucide="search"></i> Find Your Bus</h3>
        <div style="position: relative;">
            <i data-lucide="search"
                style="position: absolute; left: 10px; top: 12px; color: var(--text-muted); width: 16px;"></i>
            <input type="text" id="search-bar" placeholder="Search Bus No. or Route..." onkeyup="filterBuses()"
                style="padding-left: 2.5rem; border-radius: 50px;">
        </div>

        <div id="bus-list" style="max-height: 450px; overflow-y: auto; padding-right: 5px;">
            <!-- Bus List Items -->
        </div>
    </div>
</div>
</div>

<!-- Schedule Modal -->
<div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    onclick="closeModal(event)">
    <div class="card" style="width: 400px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
        <div class="flex justify-between items-center mb-4">
            <h3><i data-lucide="calendar"></i> Bus Timetable</h3>
            <button onclick="document.getElementById('schedule-modal').classList.add('hidden')"
                class="btn btn-sm btn-ghost">âœ•</button>
        </div>
        <div id="schedule-content">Loading...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const map = L.map('map').setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let markers = {};
    let polylines = {};
    let allBuses = [];

    async function updateBuses() {
        try {
            const res = await fetch('/api/buses');
            allBuses = await res.json();
            renderBuses();
        } catch (e) { console.error(e); }
    }

    // Close Modal Logic
    function closeModal(e) {
        if (e.target.id === 'schedule-modal') e.target.classList.add('hidden');
    }

    async function viewSchedule(busId, busNo) {
        const modal = document.getElementById('schedule-modal');
        const content = document.getElementById('schedule-content');
        modal.classList.remove('hidden');
        content.innerHTML = '<p class="text-center text-muted">Fetching Timetable...</p>';

        try {
            const res = await fetch(`/api/schedules/${busId}`);
            const stops = await res.json();

            if (stops.length === 0) {
                content.innerHTML = '<p class="text-center text-muted">No schedule uploaded for this bus yet.</p>';
            } else {
                content.innerHTML = stops.map(s => `
                    <div class="flex justify-between items-center border-b p-2">
                        <span>${s.stop}</span>
                        <strong class="text-primary">${s.time}</strong>
                    </div>
                `).join('');
            }
        } catch (e) { content.innerHTML = '<p class="text-danger">Error loading schedule.</p>'; }
    }

    let firstActiveBus = null;

    function renderBuses() {
        const query = document.getElementById('search-bar').value.toLowerCase();
        const list = document.getElementById('bus-list');
        list.innerHTML = '';

        const filtered = allBuses.filter(b => b.number.toLowerCase().includes(query) || b.route.toLowerCase().includes(query));

        if (filtered.length === 0) {
            list.innerHTML = '<div class="text-center p-4 text-muted">No buses found active.</div>';
        }

        // Reset focus tracker
        let activeBounds = L.latLngBounds([]);
        let hasActive = false;

        filtered.forEach(bus => {
            const isActive = bus.status === 'active';
            if (isActive) hasActive = true;

            // Dynamic Links
            let gmapsLink = bus.gmaps;
            if (isActive && bus.lat && bus.lon) {
                gmapsLink = `https://www.google.com/maps/search/?api=1&query=${bus.lat},${bus.lon}`;
            }

            // Route Stops Logic
            let stopsHTML = '';
            if (bus.stops) {
                try {
                    const stops = JSON.parse(bus.stops);
                    if (stops.length > 0) {
                        stopsHTML = `<div class="mt-2 text-xs" style="border-left: 2px solid var(--border); padding-left: 10px; margin-left: 5px;">
                            <div class="text-muted font-bold mb-1">Route Stops</div>
                            ${stops.map(s => `<div style="margin-bottom:2px">â—‹ ${s.name}</div>`).join('')}
                        </div>`;
                    }
                } catch (e) { }
            }

            const item = document.createElement('div');
            item.className = 'list-item';
            // Highlight if active
            if (isActive) {
                item.style.borderLeft = "4px solid var(--success)";
                item.style.cursor = 'pointer';
                item.onclick = (e) => {
                    // Prevent trigger when clicking buttons
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I' && e.target.tagName !== 'A') {
                        focusBus(bus.lat, bus.lon);
                    }
                };
            }

            item.innerHTML = `
                <div style="width: 100%;">
                    <div class="flex justify-between items-center mb-1">
                        <strong style="font-size: 1.1rem; color: var(--primary-dark);">${bus.number}</strong>
                        <span class="badge ${isActive ? 'bg-green' : 'bg-gray'}">${bus.status}</span>
                    </div>
                    ${isActive ? `<div class="text-xs text-primary mb-1" style="font-style:italic;">Click card to locate</div>` : ''}
                    <div class="text-xs text-muted mb-2"><i data-lucide="map-pin" width="12" style="display:inline;"></i> ${bus.route}</div>
                    
                    ${isActive ? `
                    <div style="background: rgba(79, 70, 229, 0.05); padding: 8px; border-radius: 8px; margin-bottom: 8px;">
                         <div class="flex justify-between text-xs font-bold" style="color: var(--primary);">
                            <span><i data-lucide="clock" width="12"></i> ETA: ${bus.next_arrival || 'Calculating...'}</span>
                        </div>
                        <div class="text-xs text-muted mt-1">Driver: ${bus.driver || 'Assigned'}</div>
                    </div>` : ''}
                    
                    ${stopsHTML}

                    <div class="flex gap-2 mt-2">
                        ${gmapsLink ? `<a href="${gmapsLink}" target="_blank" class="btn btn-sm btn-primary flex-1" style="justify-content: center;"><i data-lucide="navigation" width="12"></i> Track</a>` : ``}
                        <button onclick="viewSchedule(${bus.id}, '${bus.number}')" class="btn btn-sm btn-ghost flex-1 border">
                            <i data-lucide="calendar" width="12"></i> Schedule
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(item);

            // Update Map
            if (bus.lat && bus.lon && isActive) {
                activeBounds.extend([bus.lat, bus.lon]); // Add to bounds

                if (markers[bus.id]) {
                    markers[bus.id].setLatLng([bus.lat, bus.lon]);
                } else {
                    const icon = L.divIcon({
                        className: 'bus-marker',
                        html: `<div style="background:var(--primary); color:white; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 15px rgba(0,0,0,0.4); font-weight:bold; font-size:16px; border:2px solid white;">ðŸšŒ</div>`,
                        iconSize: [35, 35]
                    });

                    markers[bus.id] = L.marker([bus.lat, bus.lon], { icon: icon }).addTo(map)
                        .bindPopup(`<b>${bus.number}</b><br>Driver: ${bus.driver}<br>ETA: ${bus.next_arrival}`)
                        .on('click', () => focusBus(bus.lat, bus.lon));
                }
            } else if (markers[bus.id]) {
                map.removeLayer(markers[bus.id]);
                delete markers[bus.id];
            }

            // Route Lines
            if (bus.coords) {
                try {
                    const latlngs = JSON.parse(bus.coords);
                    if (!polylines[bus.id]) {
                        polylines[bus.id] = L.polyline(latlngs, { color: '#6366f1', weight: 5, opacity: 0.6 }).addTo(map);
                        // Also add route to bounds if this bus is active
                        if (isActive) latlngs.forEach(pt => activeBounds.extend(pt));
                    }
                } catch (e) { }
            }
        });

        // Auto-Zoom Logic: If we have active buses/routes, fit the map to show them
        if (hasActive && activeBounds.isValid()) {
            map.fitBounds(activeBounds, { padding: [50, 50], maxZoom: 15, animate: true });
        }

        lucide.createIcons();
    }

    function focusBus(lat, lon) {
        map.flyTo([lat, lon], 16, { animate: true, duration: 1.5 });
    }

    function filterBuses() { renderBuses(); }
    setInterval(updateBuses, 5000);
    updateBuses();
</script>
{% endblock %}