{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    .tab-btn {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: var(--text-muted);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-btn.active {
        border-bottom-color: var(--primary);
        color: var(--primary);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- KPI Stats Row -->
<div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="padding: 1rem; display: flex; align-items: center; gap: 1rem;">
        <div style="background: var(--primary-light); padding: 10px; border-radius: 50%;">
            <i data-lucide="bus" color="white"></i>
        </div>
        <div>
            <h4 class="text-muted" style="font-size: 0.9rem;">Total Fleet</h4>
            <strong style="font-size: 1.5rem;" id="stat-total">--</strong>
        </div>
    </div>
    <div class="card" style="padding: 1rem; display: flex; align-items: center; gap: 1rem;">
        <div style="background: var(--success); padding: 10px; border-radius: 50%;">
            <i data-lucide="activity" color="white"></i>
        </div>
        <div>
            <h4 class="text-muted" style="font-size: 0.9rem;">Active Now</h4>
            <strong style="font-size: 1.5rem;" id="stat-active">--</strong>
        </div>
    </div>
    <div class="card" style="padding: 1rem; display: flex; align-items: center; gap: 1rem;">
        <div style="background: var(--danger); padding: 10px; border-radius: 50%;">
            <i data-lucide="alert-triangle" color="white"></i>
        </div>
        <div>
            <h4 class="text-muted" style="font-size: 0.9rem;">SOS Alerts</h4>
            <strong style="font-size: 1.5rem;" id="stat-sos">0</strong>
        </div>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="card"
    style="padding: 0; margin-bottom: 1.5rem; display: flex; gap: 1rem; border-bottom: 1px solid #eee; overflow: hidden;">
    <div class="tab-btn active" onclick="switchTab('overview')"><i data-lucide="layout-dashboard" width="16"></i>
        Overview</div>
    <div class="tab-btn" onclick="switchTab('users')"><i data-lucide="users" width="16"></i> User Management</div>
    <div class="tab-btn" onclick="switchTab('transport')"><i data-lucide="shield" width="16"></i> Transport Dept</div>
    <div class="tab-btn" onclick="switchTab('fleet')"><i data-lucide="bus" width="16"></i> Fleet Status</div>
</div>

<!-- TAB: OVERVIEW -->
<div id="overview" class="tab-content active px-2">
    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
        <!-- Map Section -->
        <div class="card mb-0">
            <div class="flex justify-between items-center mb-2">
                <h3><i data-lucide="map"></i> Live Fleet Overview</h3>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-ghost" onclick="map.invalidateSize();"> <!-- Removed Alert -->
                        <i data-lucide="refresh-cw" width="14"></i>
                    </button>
                    <span class="badge bg-green">Live Updates On</span>
                </div>
            </div>
            <div id="map" style="height: 450px; width: 100%; border-radius: var(--radius-sm);"></div>
        </div>

        <!-- SOS & Alerts -->
        <div class="card mb-0 bg-red-50 border-danger">
            <h3 class="text-danger"><i data-lucide="alert-octagon"></i> Recent SOS Alerts</h3>
            <div id="sos-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- TAB: USERS -->
<div id="users" class="tab-content px-2">
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h3>All Registered Users</h3>
            <a href="/api/export/csv" class="btn btn-sm btn-secondary"><i data-lucide="download"></i> Export CSV</a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray text-muted uppercase font-bold">
                    <tr>
                        <th class="p-3">Name</th>
                        <th class="p-3">Email</th>
                        <th class="p-3">Role</th>
                        <th class="p-3">Status</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>

        <h3 class="mt-8 mb-4">Pending Approvals</h3>
        <div id="pending-list" class="grid grid-cols-2 gap-2"></div>
    </div>
</div>

<!-- TAB: TRANSPORT DEPT -->
<div id="transport" class="tab-content px-2">
    <div class="card" style="max-width: 800px; margin: 0 auto;">
        <div class="flex justify-between items-center mb-4">
            <h3>Transport Department Officers</h3>
            <button onclick="document.getElementById('transport-modal').classList.remove('hidden')"
                class="btn btn-primary">
                <i data-lucide="user-plus"></i> Add Officer
            </button>
        </div>
        <div id="transport-list" class="grid gap-2"></div>
    </div>
</div>

<!-- TAB: FLEET -->
<div id="fleet" class="tab-content px-2">
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h3>Fleet Status</h3>
            <div class="text-xs text-muted">Note: Bus Management is handled by Transport Dept.</div>
        </div>
        <div id="bus-grid" class="grid grid-cols-2 gap-4">
            <!-- Populated via JS -->
        </div>

        <h3 class="mt-8 mb-4"><i data-lucide="calendar"></i> Schedules</h3>
        <button onclick="openScheduleManager()" class="btn btn-ghost mb-4">
            View / Manage Timetables
        </button>
    </div>
</div>

<!-- MODALS -->
<!-- Transport Modal -->
<div id="transport-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="card" style="width: 400px; max-width: 90%;">
        <h3>Add Transport Officer</h3>
        <input type="text" id="t-name" placeholder="Name" class="mb-2">
        <input type="email" id="t-email" placeholder="Email" class="mb-2">
        <input type="password" id="t-pass" placeholder="Password" class="mb-4">
        <div class="flex gap-2">
            <button onclick="addTransportUser()" class="btn btn-primary flex-1">Create</button>
            <button onclick="document.getElementById('transport-modal').classList.add('hidden')"
                class="btn btn-ghost flex-1">Cancel</button>
        </div>
    </div>
</div>

<!-- Schedule Manager Modal -->
<div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="card" style="width: 500px; max-width: 95%; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="flex justify-between items-center mb-4">
            <h3 class="m-0"><i data-lucide="calendar"></i> Manage Timetable</h3>
            <button onclick="document.getElementById('schedule-modal').classList.add('hidden')"
                class="btn btn-sm btn-ghost">✕</button>
        </div>

        <div class="mb-4">
            <label class="text-xs text-muted font-bold">SELECT BUS</label>
            <select id="sched-bus-select" class="w-full p-2 border rounded" onchange="loadScheduleForBus()">
                <option value="">-- Choose Bus --</option>
            </select>
        </div>

        <div class="flex-1 overflow-y-auto border rounded p-2 bg-gray mb-4" id="sched-rows" style="min-height: 200px;">
            <p class="text-xs text-muted text-center mt-4">Select a bus to view/edit schedule.</p>
        </div>

        <button onclick="addSchedRow()" class="btn btn-sm btn-secondary mb-4 w-full dashed-border">+ Add Stop
            Row</button>

        <div class="flex gap-2">
            <button onclick="saveSchedule()" class="btn btn-primary flex-1">Save Timetable</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- TABS LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        event.currentTarget.classList.add('active');
        document.getElementById(tabId).classList.add('active');

        if (tabId === 'overview') setTimeout(() => map.invalidateSize(), 100);
    }

    // --- MAP & DATA LOGIC ---
    const map = L.map('map').setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let markers = {};

    async function loadData() {
        try {
            // 1. Buses
            const resBuses = await fetch('/api/buses');
            const buses = await resBuses.json();

            // Stats
            document.getElementById('stat-total').innerText = buses.length;
            document.getElementById('stat-active').innerText = buses.filter(b => b.status === 'active').length;

            // Bus Grid (Flagship Tab)
            const busGrid = document.getElementById('bus-grid');
            busGrid.innerHTML = '';
            buses.forEach(b => {
                // Map Logic
                if (b.lat && b.lon && b.status === 'active') {
                    if (markers[b.id]) markers[b.id].setLatLng([b.lat, b.lon]);
                    else markers[b.id] = L.marker([b.lat, b.lon]).addTo(map).bindPopup(`<b>${b.number}</b>`);
                } else if (markers[b.id]) { map.removeLayer(markers[b.id]); delete markers[b.id]; }

                // Grid Logic
                const div = document.createElement('div');
                div.className = 'list-item p-3 border rounded bg-gray-50';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <strong>${b.number}</strong>
                        <span class="badge ${b.status === 'active' ? 'bg-green' : 'bg-gray'}">${b.status}</span>
                    </div>
                    <div class="text-xs text-muted mt-1">${b.route}</div>
                    <div class="text-xs mt-2 font-mono">${b.driver || 'No Driver'}</div>
                `;
                busGrid.appendChild(div);
            });

            // 2. SOS
            const resSOS = await fetch('/api/sos/history');
            const alerts = await resSOS.json();
            document.getElementById('stat-sos').innerText = alerts.length;

            const sosList = document.getElementById('sos-list');
            sosList.innerHTML = alerts.length ? '' : '<p class="text-xs text-muted">No alerts.</p>';
            alerts.slice(0, 10).forEach(a => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.background = '#fff';
                div.innerHTML = `
                    <div>
                        <div class="text-danger flex items-center gap-2 font-bold text-sm">
                            <i data-lucide="alert-circle" width="14"></i> ${a.driver}
                        </div>
                        <div class="text-xs font-bold text-danger mt-1">Reason: ${a.reason || 'Emergency'}</div>
                        <div class="text-xs text-muted">${a.time}</div>
                    </div>
                    <a href="https://maps.google.com/?q=${a.lat},${a.lon}" target="_blank" class="text-xs btn btn-sm btn-ghost">Map</a>
                `;
                sosList.appendChild(div);
            });

            // 3. User Approvals
            const resPending = await fetch('/api/users/pending');
            const pending = await resPending.json();
            const pendingList = document.getElementById('pending-list');
            pendingList.innerHTML = pending.length ? '' : '<p class="text-xs text-muted col-span-2">No pending approvals.</p>';

            pending.forEach(u => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div><strong>${u.name}</strong> <span class="text-xs text-muted">(${u.role})</span></div>
                    <div class="flex gap-1">
                        <button onclick="approve(${u.id}, true)" class="btn btn-sm btn-success">✓</button>
                        <button onclick="approve(${u.id}, false)" class="btn btn-sm btn-danger">✗</button>
                    </div>
                `;
                pendingList.appendChild(div);
            });

            // 4. All Users Table
            // Only fetch if "Users" tab is active or first load to simple-populate? 
            // Better: fetch always for simplicity in this prototype.
            const resAll = await fetch('/api/users/all');
            const allUsers = await resAll.json();
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';

            allUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3 text-muted">${u.email}</td>
                    <td class="p-3"><span class="badge bg-gray">${u.role}</span></td>
                    <td class="p-3"><span class="badge ${u.approved ? 'bg-green' : 'bg-red'}">${u.approved ? 'Active' : 'Pending'}</span></td>
                `;
                tableBody.appendChild(tr);
            });

            lucide.createIcons();

        } catch (e) { console.error(e); }
    }

    async function approve(id, status) {
        await fetch('/api/users/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: id, approved: status })
        });
        loadData();
    }

    // Transport Officers
    async function loadTransport() {
        try {
            const res = await fetch('/api/users/transport');
            const users = await res.json();
            const list = document.getElementById('transport-list');
            list.innerHTML = users.length ? '' : '<p class="text-xs text-muted mb-2">No officers found.</p>';

            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div><strong>${u.name}</strong> <span class="text-xs text-muted"> - ${u.email}</span></div>
                    <span class="badge bg-green">Active</span>
                `;
                list.appendChild(div);
            });
        } catch (e) { }
    }

    async function addTransportUser() {
        const name = document.getElementById('t-name').value;
        const email = document.getElementById('t-email').value;
        const pass = document.getElementById('t-pass').value;
        if (!name || !email || !pass) return alert("All fields required");

        const res = await fetch('/api/users/transport', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password: pass })
        });
        if (res.ok) {
            alert("Added!");
            document.getElementById('transport-modal').classList.add('hidden');
            loadTransport();
        } else { alert("Error adding user"); }
    }

    // Schedule Logic
    let currentSchedBusId = null;
    async function openScheduleManager() {
        document.getElementById('schedule-modal').classList.remove('hidden');
        const select = document.getElementById('sched-bus-select');
        if (select.options.length <= 1) {
            const res = await fetch('/api/buses');
            const buses = await res.json();
            buses.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.text = `${b.number} - ${b.route}`;
                select.appendChild(opt);
            });
        }
    }
    async function loadScheduleForBus() {
        const busId = document.getElementById('sched-bus-select').value;
        currentSchedBusId = busId;
        const container = document.getElementById('sched-rows');
        container.innerHTML = 'Loading...';
        if (!busId) { container.innerHTML = '<p class="text-xs text-muted text-center mt-4">Select a bus.</p>'; return; }

        try {
            const res = await fetch(`/api/schedules/${busId}`);
            const stops = await res.json();
            container.innerHTML = '';
            if (stops.length === 0) { addSchedRow(); addSchedRow(); }
            else { stops.forEach(s => addSchedRow(s.stop, s.time)); }
        } catch (e) { container.innerHTML = 'Error'; }
    }
    function addSchedRow(stop = '', time = '') {
        const container = document.getElementById('sched-rows');
        const div = document.createElement('div');
        div.className = 'flex gap-2 mb-2 sched-row';
        div.innerHTML = `
            <input type="text" placeholder="Stop Name" class="p-2 border rounded flex-1 stop-input" value="${stop}">
            <input type="text" placeholder="Time" class="p-2 border rounded w-32 time-input" value="${time}">
            <button onclick="this.parentElement.remove()" class="btn btn-sm btn-ghost text-danger">✕</button>
        `;
        container.appendChild(div);
    }
    async function saveSchedule() {
        if (!currentSchedBusId) return alert("Select a bus first");
        const rows = document.querySelectorAll('.sched-row');
        const payload = [];
        rows.forEach(r => {
            const s = r.querySelector('.stop-input').value;
            const t = r.querySelector('.time-input').value;
            if (s && t) payload.push({ stop: s, time: t });
        });
        await fetch(`/api/schedules/${currentSchedBusId}`, { method: 'DELETE' });
        for (const item of payload) {
            await fetch('/api/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bus_id: currentSchedBusId, stop: item.stop, time: item.time })
            });
        }
        alert("Saved!");
        document.getElementById('schedule-modal').classList.add('hidden');
    }

    // Init
    loadData();
    loadTransport();
    setInterval(loadData, 5000);
</script>
{% endblock %}